<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Evaluation Chart | Coin Collection Tracker</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Lightweight Charts -->
  
  <style>
    :root {
      --bg-primary: #08080c;
      --bg-secondary: #0f0f14;
      --bg-tertiary: #16161e;
      --bg-card: rgba(255, 255, 255, 0.02);
      
      --text-primary: rgba(255, 255, 255, 0.95);
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      
      --accent-gold: #F7931A;
      --accent-gold-dim: rgba(247, 147, 26, 0.15);
      --accent-teal: #14B8A6;
      --accent-emerald: #10B981;
      --accent-cyan: #00D9FF;
      
      --positive: #22C55E;
      --negative: #EF4444;
      
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-active: rgba(255, 255, 255, 0.15);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    
    .portfolio-chart-container {
      width: 100%;
      max-width: 1000px;
      background: var(--bg-secondary);
      background-image: 
        radial-gradient(ellipse at 15% 0%, rgba(247, 147, 26, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 85% 100%, rgba(20, 184, 166, 0.04) 0%, transparent 50%);
      border-radius: 20px;
      padding: 28px;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.03) inset;
    }
    
    .portfolio-chart-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E");
      pointer-events: none;
      opacity: 0.4;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
      gap: 24px;
    }
    
    .header-left {
      flex: 1;
      min-width: 300px;
    }
    
    .title-section {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }
    
    .chart-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.03em;
    }
    
    .currency-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 5px 10px;
      border-radius: 5px;
      border: 1px solid var(--border-subtle);
      letter-spacing: 0.08em;
    }
    
    .stats-row {
      display: flex;
      gap: 28px;
      flex-wrap: wrap;
    }
    
    .stat-item {
      display: flex;
      align-items: stretch;
      gap: 14px;
    }
    
    .stat-indicator {
      width: 3px;
      border-radius: 2px;
      transition: box-shadow 0.3s ease;
    }
    
    .stat-indicator.metal {
      background: linear-gradient(180deg, var(--accent-gold) 0%, rgba(247, 147, 26, 0.2) 100%);
    }
    
    .stat-indicator.collector {
      background: linear-gradient(180deg, var(--accent-emerald) 0%, rgba(20, 184, 166, 0.2) 100%);
    }
    
    .stat-item:hover .stat-indicator {
      box-shadow: 0 0 16px var(--accent-gold);
    }
    
    .stat-item:hover .stat-indicator.collector {
      box-shadow: 0 0 16px var(--accent-emerald);
    }
    
    .stat-content {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    
    .stat-label {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 500;
    }
    
    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }
    
    .stat-change {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      font-weight: 500;
    }
    
    .stat-change.positive { color: var(--positive); }
    .stat-change.negative { color: var(--negative); }
    
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 14px;
    }
    
    .controls-group {
      display: flex;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 4px;
    }
    
    .control-btn {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 9px 15px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 7px;
      transition: all 0.2s ease;
    }
    
    .control-btn svg {
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }
    
    .control-btn:hover {
      color: var(--text-secondary);
    }
    
    .control-btn:hover svg {
      opacity: 0.7;
    }
    
    .control-btn.active {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .control-btn.active svg {
      opacity: 1;
    }
    
    .timeframe-btn {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      font-weight: 500;
      padding: 9px 13px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 7px;
      transition: all 0.2s ease;
      letter-spacing: 0.03em;
    }
    
    .timeframe-btn:hover {
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.02);
    }
    
    .timeframe-btn.active {
      background: var(--accent-gold);
      color: var(--bg-primary);
      box-shadow: 0 0 20px rgba(247, 147, 26, 0.35);
    }
    
    .chart-legend {
      display: flex;
      gap: 22px;
      margin-bottom: 18px;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .legend-line {
      width: 26px;
      height: 3px;
      border-radius: 2px;
    }
    
    .legend-line.metal {
      background: var(--accent-gold);
      box-shadow: 0 0 12px rgba(247, 147, 26, 0.5);
    }
    
    .legend-line.collector-max {
      background: var(--accent-emerald);
    }
    
    .legend-line.collector-min {
      background: var(--accent-teal);
    }
    
    .legend-line.collector-exact {
      background: var(--accent-cyan);
      box-shadow: 0 0 12px rgba(0, 217, 255, 0.5);
    }
    
    .legend-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .chart-wrapper {
      position: relative;
      height: 380px;
      background: rgba(255, 255, 255, 0.015);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      overflow: hidden;
    }
    
    #chart-container {
      width: 100%;
      height: 100%;
    }
    
    .chart-gradient-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: linear-gradient(to top, rgba(15, 15, 20, 0.7) 0%, transparent 100%);
      pointer-events: none;
    }
    
    .chart-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 18px;
      padding-top: 18px;
      border-top: 1px solid var(--border-subtle);
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .footer-text {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.7rem;
      color: var(--text-muted);
      letter-spacing: 0.02em;
    }
    
    .footer-text svg {
      opacity: 0.5;
    }
    
    .footer-text.powered {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.62rem;
      opacity: 0.5;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 20px 12px;
      }
      
      .portfolio-chart-container {
        padding: 18px;
      }
      
      .chart-header {
        flex-direction: column;
      }
      
      .header-left {
        min-width: auto;
        width: 100%;
      }
      
      .header-right {
        align-items: stretch;
        width: 100%;
      }
      
      .controls-group {
        width: 100%;
      }
      
      .control-btn,
      .timeframe-btn {
        flex: 1;
        justify-content: center;
        padding: 10px 8px;
      }
      
      .stats-row {
        flex-direction: column;
        gap: 18px;
      }
      
      .chart-wrapper {
        height: 300px;
      }
      
      .chart-legend {
        gap: 14px;
      }
      
      .chart-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    /* Loading state */
    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(8, 8, 12, 0.8);
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .loading-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent-gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="portfolio-chart-container">
    <!-- Header -->
    <div class="chart-header">
      <div class="header-left">
        <div class="title-section">
          <h2 class="chart-title">Portfolio Value</h2>
          <span class="currency-badge">EUR</span>
        </div>
        
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-indicator metal"></div>
            <div class="stat-content">
              <span class="stat-label">Metal Value</span>
              <span class="stat-value" id="metal-value">€0.00</span>
              <span class="stat-change" id="metal-change">+0.00%</span>
            </div>
          </div>
          
          <div class="stat-item">
            <div class="stat-indicator collector"></div>
            <div class="stat-content">
              <span class="stat-label" id="collector-label">Collector Value (Avg)</span>
              <span class="stat-value" id="collector-value">€0.00</span>
              <span class="stat-change" id="collector-change">+0.00%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="header-right">
        <!-- Value Mode Toggle -->
        <div class="controls-group" id="mode-toggle">
          <button class="control-btn active" data-mode="range">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
            Range
          </button>
          <button class="control-btn" data-mode="exact">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
            </svg>
            Exact
          </button>
        </div>

        <!-- Timeframe Selector -->
        <div class="controls-group" id="timeframe-selector">
          <button class="timeframe-btn" data-timeframe="1h">1H</button>
          <button class="timeframe-btn" data-timeframe="1d">1D</button>
          <button class="timeframe-btn" data-timeframe="1w">1W</button>
          <button class="timeframe-btn active" data-timeframe="1M">1M</button>
          <button class="timeframe-btn" data-timeframe="1Y">1Y</button>
          <button class="timeframe-btn" data-timeframe="MAX">MAX</button>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="chart-legend" id="chart-legend">
      <div class="legend-item">
        <span class="legend-line metal"></span>
        <span class="legend-text">Metal Value</span>
      </div>
      <div class="legend-item" id="legend-max">
        <span class="legend-line collector-max"></span>
        <span class="legend-text">Collector Max</span>
      </div>
      <div class="legend-item" id="legend-min">
        <span class="legend-line collector-min"></span>
        <span class="legend-text">Collector Min</span>
      </div>
      <div class="legend-item" id="legend-exact" style="display: none;">
        <span class="legend-line collector-exact"></span>
        <span class="legend-text">Collector Exact</span>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-wrapper">
      <div id="chart-container"></div>
      <div class="chart-gradient-overlay"></div>
      <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="chart-footer">
      <span class="footer-text">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
        Data updates every snapshot • Weekend gaps excluded
      </span>
      <span class="footer-text powered">
        Powered by TradingView Lightweight Charts
      </span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // Fallback loader if first CDN fails
    if (typeof LightweightCharts === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js';
      document.head.appendChild(script);
    }
  </script>
  <script>
    // Configuration
    const TIMEFRAME_CONFIGS = {
      '1h': { intervalMs: 60 * 1000, dataPoints: 60 },
      '1d': { intervalMs: 5 * 60 * 1000, dataPoints: 288 },
      '1w': { intervalMs: 30 * 60 * 1000, dataPoints: 336 },
      '1M': { intervalMs: 4 * 60 * 60 * 1000, dataPoints: 180 },
      '1Y': { intervalMs: 24 * 60 * 60 * 1000, dataPoints: 365 },
      'MAX': { intervalMs: 24 * 60 * 60 * 1000, dataPoints: 730 }
    };

    // State
    let chart = null;
    let metalValueSeries = null;
    let collectorExactSeries = null;
    let collectorMinSeries = null;
    let collectorMaxSeries = null;
    let sampleData = [];
    let selectedTimeframe = '1M';
    let valueMode = 'range';

    // Initialize chart
    function initChart() {
      const container = document.getElementById('chart-container');
      
      chart = LightweightCharts.createChart(container, {
        layout: {
          background: { type: 'solid', color: 'transparent' },
          textColor: 'rgba(255, 255, 255, 0.6)',
          fontFamily: "'JetBrains Mono', monospace",
          fontSize: 11,
        },
        grid: {
          vertLines: { color: 'rgba(255, 255, 255, 0.025)' },
          horzLines: { color: 'rgba(255, 255, 255, 0.025)' },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Magnet,
          vertLine: {
            color: 'rgba(255, 255, 255, 0.15)',
            width: 1,
            style: LightweightCharts.LineStyle.Dashed,
            labelBackgroundColor: 'rgba(22, 22, 30, 0.95)',
          },
          horzLine: {
            color: 'rgba(255, 255, 255, 0.15)',
            width: 1,
            style: LightweightCharts.LineStyle.Dashed,
            labelBackgroundColor: 'rgba(22, 22, 30, 0.95)',
          },
        },
        rightPriceScale: {
          borderColor: 'rgba(255, 255, 255, 0.08)',
          scaleMargins: { top: 0.12, bottom: 0.12 },
        },
        timeScale: {
          borderColor: 'rgba(255, 255, 255, 0.08)',
          timeVisible: true,
          secondsVisible: false,
          fixLeftEdge: true,
          fixRightEdge: true,
        },
        handleScroll: { vertTouchDrag: false },
      });

      // Metal Value Series (Gold)
      metalValueSeries = chart.addLineSeries({
        color: '#F7931A',
        lineWidth: 2,
        priceLineVisible: false,
        lastValueVisible: true,
        crosshairMarkerVisible: true,
        crosshairMarkerRadius: 5,
        crosshairMarkerBorderColor: '#F7931A',
        crosshairMarkerBackgroundColor: '#0f0f14',
      });

      // Collector Exact Series (Cyan)
      collectorExactSeries = chart.addLineSeries({
        color: '#00D9FF',
        lineWidth: 2,
        priceLineVisible: false,
        lastValueVisible: true,
        crosshairMarkerVisible: true,
        crosshairMarkerRadius: 5,
        crosshairMarkerBorderColor: '#00D9FF',
        crosshairMarkerBackgroundColor: '#0f0f14',
        visible: false,
      });

      // Collector Min Series (Teal)
      collectorMinSeries = chart.addLineSeries({
        color: '#14B8A6',
        lineWidth: 1.5,
        lineStyle: LightweightCharts.LineStyle.Solid,
        priceLineVisible: false,
        lastValueVisible: false,
        crosshairMarkerVisible: false,
      });

      // Collector Max Series (Emerald)
      collectorMaxSeries = chart.addLineSeries({
        color: '#10B981',
        lineWidth: 1.5,
        lineStyle: LightweightCharts.LineStyle.Solid,
        priceLineVisible: false,
        lastValueVisible: true,
        crosshairMarkerVisible: true,
        crosshairMarkerRadius: 5,
        crosshairMarkerBorderColor: '#10B981',
        crosshairMarkerBackgroundColor: '#0f0f14',
      });

      // Handle resize
      const resizeObserver = new ResizeObserver(entries => {
        if (entries.length > 0 && chart) {
          const { width, height } = entries[0].contentRect;
          chart.applyOptions({ width, height });
        }
      });
      resizeObserver.observe(container);
    }

    // Generate realistic sample data
    function generateSampleData() {
      const now = Date.now();
      const config = TIMEFRAME_CONFIGS['MAX'];
      
      let metalBase = 220;
      let collectorBase = 190;
      
      // Different trends for variety
      const metalTrend = 0.00015;
      const collectorTrend = 0.0002;
      const volatility = 0.012;

      for (let i = config.dataPoints; i >= 0; i--) {
        const timestamp = now - (i * config.intervalMs);
        const date = new Date(timestamp);
        
        // Skip weekends
        if (date.getDay() === 0 || date.getDay() === 6) {
          continue;
        }

        // Add some market-like behavior
        const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
        const seasonalFactor = Math.sin(dayOfYear / 365 * Math.PI * 2) * 0.03;
        
        const metalRandom = (Math.random() - 0.5) * volatility;
        const collectorRandom = (Math.random() - 0.5) * volatility * 1.2;
        
        const trendFactor = config.dataPoints - i;
        
        metalBase *= (1 + metalRandom + seasonalFactor * 0.001);
        metalBase = Math.max(160, Math.min(380, metalBase));
        
        collectorBase *= (1 + collectorRandom + seasonalFactor * 0.001);
        collectorBase = Math.max(120, Math.min(450, collectorBase));
        
        // Variable spread that increases with time
        const spreadFactor = 0.2 + Math.random() * 0.25;
        const collectorSpread = collectorBase * spreadFactor;
        
        // Some entries have exact values, others have ranges
        const hasExact = Math.random() > 0.4;
        
        sampleData.push({
          id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substr(2, 9),
          snapshot_date: date.toISOString().split('T')[0],
          currency_code: 'EUR',
          total_coins: 3,
          total_quantity: 3,
          metal_value: parseFloat((metalBase * (1 + metalTrend * trendFactor)).toFixed(4)),
          gold_grams: 0,
          silver_grams: 93.2067,
          platinum_grams: 0,
          collector_value_exact: hasExact ? parseFloat((collectorBase * (1 + collectorTrend * trendFactor)).toFixed(4)) : 0,
          collector_value_min: parseFloat(((collectorBase - collectorSpread / 2) * (1 + collectorTrend * trendFactor)).toFixed(4)),
          collector_value_max: parseFloat(((collectorBase + collectorSpread / 2) * (1 + collectorTrend * trendFactor)).toFixed(4)),
          created_at: date.toISOString(),
        });
      }
    }

    // Filter data by timeframe
    function getFilteredData() {
      const now = Date.now();
      const config = TIMEFRAME_CONFIGS[selectedTimeframe];
      const cutoff = now - (config.dataPoints * config.intervalMs);
      
      return sampleData.filter(d => new Date(d.created_at).getTime() >= cutoff);
    }

    // Update chart with data
    function updateChart() {
      showLoading(true);
      
      setTimeout(() => {
        const filteredData = getFilteredData();
        
        const metalData = [];
        const exactData = [];
        const minData = [];
        const maxData = [];

        filteredData.forEach(snapshot => {
          const time = Math.floor(new Date(snapshot.created_at).getTime() / 1000);
          
          metalData.push({ time, value: snapshot.metal_value });
          
          if (snapshot.collector_value_exact > 0) {
            exactData.push({ time, value: snapshot.collector_value_exact });
          }
          
          minData.push({ time, value: snapshot.collector_value_min });
          maxData.push({ time, value: snapshot.collector_value_max });
        });

        metalValueSeries.setData(metalData);
        collectorExactSeries.setData(exactData);
        collectorMinSeries.setData(minData);
        collectorMaxSeries.setData(maxData);

        updateSeriesVisibility();
        chart.timeScale().fitContent();
        updateStats(filteredData);
        
        showLoading(false);
      }, 150);
    }

    // Update series visibility
    function updateSeriesVisibility() {
      if (valueMode === 'exact') {
        collectorExactSeries.applyOptions({ visible: true });
        collectorMinSeries.applyOptions({ visible: false });
        collectorMaxSeries.applyOptions({ visible: false });
        document.getElementById('legend-exact').style.display = 'flex';
        document.getElementById('legend-min').style.display = 'none';
        document.getElementById('legend-max').style.display = 'none';
        document.getElementById('collector-label').textContent = 'Collector Value';
      } else {
        collectorExactSeries.applyOptions({ visible: false });
        collectorMinSeries.applyOptions({ visible: true });
        collectorMaxSeries.applyOptions({ visible: true });
        document.getElementById('legend-exact').style.display = 'none';
        document.getElementById('legend-min').style.display = 'flex';
        document.getElementById('legend-max').style.display = 'flex';
        document.getElementById('collector-label').textContent = 'Collector Value (Avg)';
      }
    }

    // Update statistics display
    function updateStats(data) {
      if (data.length < 2) return;

      const first = data[0];
      const last = data[data.length - 1];

      const currentMetal = last.metal_value;
      const metalChange = ((last.metal_value - first.metal_value) / first.metal_value) * 100;

      let currentCollector, collectorChange;
      if (valueMode === 'exact') {
        currentCollector = last.collector_value_exact || (last.collector_value_min + last.collector_value_max) / 2;
        const firstCollector = first.collector_value_exact || (first.collector_value_min + first.collector_value_max) / 2;
        collectorChange = ((currentCollector - firstCollector) / firstCollector) * 100;
      } else {
        currentCollector = (last.collector_value_min + last.collector_value_max) / 2;
        const firstCollector = (first.collector_value_min + first.collector_value_max) / 2;
        collectorChange = ((currentCollector - firstCollector) / firstCollector) * 100;
      }

      document.getElementById('metal-value').textContent = formatCurrency(currentMetal);
      document.getElementById('metal-change').textContent = formatPercent(metalChange);
      document.getElementById('metal-change').className = `stat-change ${metalChange >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('collector-value').textContent = formatCurrency(currentCollector);
      document.getElementById('collector-change').textContent = formatPercent(collectorChange);
      document.getElementById('collector-change').className = `stat-change ${collectorChange >= 0 ? 'positive' : 'negative'}`;
    }

    // Format currency
    function formatCurrency(value) {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(value);
    }

    // Format percent
    function formatPercent(value) {
      const prefix = value >= 0 ? '+' : '';
      return `${prefix}${value.toFixed(2)}%`;
    }

    // Show/hide loading
    function showLoading(show) {
      const overlay = document.getElementById('loading-overlay');
      overlay.classList.toggle('visible', show);
    }

    // Event listeners
    function setupEventListeners() {
      // Mode toggle
      document.querySelectorAll('#mode-toggle .control-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#mode-toggle .control-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          valueMode = btn.dataset.mode;
          updateSeriesVisibility();
          updateStats(getFilteredData());
        });
      });

      // Timeframe selector
      document.querySelectorAll('#timeframe-selector .timeframe-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#timeframe-selector .timeframe-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedTimeframe = btn.dataset.timeframe;
          updateChart();
        });
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check if library loaded
      if (typeof LightweightCharts === 'undefined') {
        document.getElementById('chart-container').innerHTML = 
          '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(255,255,255,0.5);font-size:14px;">Failed to load chart library. Please refresh the page.</div>';
        return;
      }
      
      generateSampleData();
      initChart();
      setupEventListeners();
      updateChart();
    });
  </script>
</body>
</html>